# E2E Testing for Tailgater

This directory contains end-to-end testing infrastructure for Tailgater. It spins up Docker containers that generate realistic logs with errors and warnings, allowing you to test both CLI and web modes.

## What's Included

- **3 Docker containers** running Alpine Linux with SSH and log generators
- **Log generator tool** that writes realistic logs with random errors/warnings
- **Pre-configured SSH keys** for key-based auth
- **Tailgater config** ready to connect to all containers

## Quick Start

```bash
cd e2e
./setup.sh
```

This will:
1. Generate SSH keys
2. Build the log generator
3. Build and start Docker containers
4. Verify SSH connectivity

## Running Tests

### CLI Mode

```bash
cd e2e
../tailgater -config tailgater.e2e.yaml
```

You'll see logs from all 3 servers with colored highlighting for errors/warnings.

### Web Mode

```bash
cd e2e
../tailgater -config tailgater.e2e.yaml -web
```

Open http://localhost:8888 for the dashboard.

## Directory Structure

```
e2e/
├── docker/
│   ├── Dockerfile.server    # Container image with SSH + loggen
│   ├── start.sh             # Container startup script
│   └── loggen               # Built log generator binary (Linux)
├── loggen/
│   └── main.go              # Log generator source
├── ssh_keys/                # Generated by setup.sh
│   ├── id_rsa               # Private key
│   └── authorized_keys      # Public key for containers
├── tmp/                     # Docker build context (generated)
├── tailgater.e2e.yaml       # Tailgater config for testing
├── docker-compose.yml       # 3 container setup
├── setup.sh                 # One-command setup
├── cleanup.sh               # Clean up everything
└── README.md                # This file
```

## Customizing

### Adjust Log Volume

Edit `docker/start.sh` and change the `-interval` flag:

```bash
/usr/local/bin/loggen -interval 50ms   # Very chatty
/usr/local/bin/loggen -interval 1s     # Relaxed
```

### Add More Servers

1. Copy a service block in `docker-compose.yml`
2. Add corresponding server entry in `tailgater.e2e.yaml`
3. Run `docker-compose up -d`

### Change Log Patterns

Edit `loggen/main.go` and modify the `messages` map, then rebuild:

```bash
cd e2e/loggen && go build -o ../docker/loggen .
cd .. && docker-compose up --build -d
```

## Cleanup

```bash
cd e2e
./cleanup.sh
```

Or manually:
```bash
docker-compose down -v
rm -rf ssh_keys/ tmp/
rm -f docker/loggen
```

## Troubleshooting

**SSH connection refused**
- Wait a few seconds after starting containers
- Check `docker-compose logs server-1`

**Permission denied (publickey)**
- Make sure `ssh_keys/authorized_keys` exists and has the public key
- Run `setup.sh` to regenerate keys

**No logs appearing**
- Check container logs: `docker-compose logs -f server-1`
- Verify log file exists in container: `docker exec e2e-server-1-1 cat /var/log/testapp.log`
